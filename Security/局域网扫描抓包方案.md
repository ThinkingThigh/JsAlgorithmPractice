# 局域网扫描抓包方案 - 监控特定域名和端口请求

## 1. 方案概述

本方案旨在通过网络扫描和抓包技术，监控局域网内所有主机对特定域名和端口的访问请求，用于安全审计、威胁检测和网络行为分析。

## 2. 网络拓扑要求

### 2.1 监控点部署
- **镜像端口部署**：在核心交换机配置端口镜像
- **网关监控**：在网关设备上部署监控程序
- **分布式监控**：在关键网段部署监控节点

### 2.2 网络权限要求
- 具有网络设备管理权限
- 能够配置交换机镜像端口
- 具有网段扫描权限

## 3. 局域网扫描技术

### 3.1 主机发现工具

#### 3.1.1 Nmap主机扫描
```bash
# 扫描整个C类网段
nmap -sn 192.168.1.0/24

# 扫描多个网段
nmap -sn 192.168.1.0/24 192.168.2.0/24 10.0.0.0/24

# 快速扫描（仅发现存活主机）
nmap -sn --host-timeout 30s 192.168.0.0/16

# 详细扫描（包含MAC地址）
nmap -sn -oG - 192.168.1.0/24 | grep "Up"

# 输出到文件
nmap -sn 192.168.1.0/24 -oN live_hosts.txt
```

#### 3.1.2 Masscan快速扫描
```bash
# 安装masscan
sudo apt install masscan
# 或 yum install masscan

# 快速主机发现
masscan -p1-65535 192.168.1.0/24 --rate=1000

# 扫描特定端口
masscan -p80,443,22,21,23 192.168.1.0/24 --rate=1000

# 输出格式化结果
masscan -p1-1000 192.168.1.0/24 --rate=1000 -oL scan_results.txt
```

#### 3.1.3 ARP扫描
```bash
# 使用arp-scan
sudo arp-scan -l
sudo arp-scan 192.168.1.0/24

# 使用arping
for i in {1..254}; do
    arping -c 1 -W 1 192.168.1.$i 2>/dev/null | grep "bytes from" &
done
wait

# 使用netdiscover
sudo netdiscover -r 192.168.1.0/24
```

### 3.2 端口扫描工具

#### 3.2.1 目标端口扫描脚本
```bash
#!/bin/bash
# 扫描所有主机的特定端口

TARGET_PORTS="80 443 22 21 23 25 53 110 143 993 995 3389 5432 3306"
NETWORK="192.168.1"

echo "开始扫描网段 ${NETWORK}.0/24 的特定端口..."

for i in {1..254}; do
    IP="${NETWORK}.${i}"
    
    # 先检查主机是否存活
    if ping -c 1 -W 1 $IP >/dev/null 2>&1; then
        echo "正在扫描 $IP..."
        
        for port in $TARGET_PORTS; do
            if timeout 3 bash -c "echo >/dev/tcp/$IP/$port" 2>/dev/null; then
                echo "$IP:$port - OPEN"
                echo "$(date): $IP:$port OPEN" >> scan_results.log
            fi
        done
    fi &
    
    # 控制并发数
    if (( i % 20 == 0 )); then
        wait
    fi
done
wait
```

## 4. 网络抓包技术

### 4.1 TCPDump抓包

#### 4.1.1 基础抓包命令
```bash
# 抓取所有流量
tcpdump -i any -w all_traffic.pcap

# 抓取特定端口流量
tcpdump -i any port 80 -w http_traffic.pcap
tcpdump -i any port 443 -w https_traffic.pcap

# 抓取多个端口
tcpdump -i any 'port 80 or port 443 or port 22' -w multi_port.pcap

# 抓取特定主机流量
tcpdump -i any host 192.168.1.100 -w host_traffic.pcap

# 抓取DNS查询
tcpdump -i any port 53 -w dns_queries.pcap
```

#### 4.1.2 特定域名监控
```bash
# 监控DNS查询特定域名
tcpdump -i any port 53 and host 8.8.8.8 -A | grep -i "suspicious-domain.com"

# 监控HTTP请求中的特定域名
tcpdump -i any port 80 -A | grep -i "Host: suspicious-domain.com"

# 组合监控脚本
#!/bin/bash
SUSPICIOUS_DOMAIN="malicious-site.com"
LOG_FILE="/var/log/domain_monitor.log"

# 监控DNS查询
tcpdump -i any port 53 -l -A | while read line; do
    if echo "$line" | grep -qi "$SUSPICIOUS_DOMAIN"; then
        echo "$(date): DNS查询检测到可疑域名: $line" >> $LOG_FILE
    fi
done &

# 监控HTTP请求
tcpdump -i any port 80 -l -A | while read line; do
    if echo "$line" | grep -qi "Host: $SUSPICIOUS_DOMAIN"; then
        echo "$(date): HTTP请求检测到可疑域名: $line" >> $LOG_FILE
    fi
done &
```

### 4.2 Wireshark命令行工具

#### 4.2.1 Tshark使用
```bash
# 安装tshark
sudo apt install tshark
# 或 yum install wireshark

# 抓取并实时分析
tshark -i any -f "port 80" -T fields -e ip.src -e ip.dst -e http.host

# 抓取特定域名的流量
tshark -i any -Y "dns.qry.name contains \"suspicious-domain.com\""

# 监控特定端口并显示详细信息
tshark -i any -f "port 443" -V

# 输出到文件并设置轮转
tshark -i any -w capture.pcap -b filesize:100000 -b files:10
```

#### 4.2.2 域名和端口监控脚本
```bash
#!/bin/bash
# 综合监控脚本

INTERFACE="any"
SUSPICIOUS_DOMAINS=("malware.com" "phishing.net" "suspicious.org")
SUSPICIOUS_PORTS=(4444 5555 6666 7777 8888 9999)
OUTPUT_DIR="/var/log/network_monitor"

mkdir -p $OUTPUT_DIR

# 启动域名监控
for domain in "${SUSPICIOUS_DOMAINS[@]}"; do
    tshark -i $INTERFACE -Y "dns.qry.name contains \"$domain\"" \
           -T fields -e frame.time -e ip.src -e dns.qry.name \
           > "$OUTPUT_DIR/dns_${domain}.log" &
done

# 启动端口监控
for port in "${SUSPICIOUS_PORTS[@]}"; do
    tshark -i $INTERFACE -f "port $port" \
           -T fields -e frame.time -e ip.src -e ip.dst -e tcp.srcport -e tcp.dstport \
           > "$OUTPUT_DIR/port_${port}.log" &
done

echo "监控已启动，日志保存在 $OUTPUT_DIR"
```

### 4.3 专业监控工具

#### 4.3.1 Suricata IDS部署
```bash
# 安装Suricata
sudo apt update
sudo apt install suricata

# 配置文件位置
sudo vim /etc/suricata/suricata.yaml

# 基础配置
HOME_NET: "[192.168.1.0/24]"
EXTERNAL_NET: "!$HOME_NET"

# 自定义规则示例
cat > /etc/suricata/rules/custom.rules << 'EOF'
# 检测特定域名的DNS查询
alert dns any any -> any any (msg:"Suspicious Domain Query"; dns_query; content:"malicious-site.com"; sid:1000001; rev:1;)

# 检测特定端口的连接
alert tcp any any -> any 4444 (msg:"Suspicious Port 4444 Connection"; sid:1000002; rev:1;)

# 检测HTTP请求中的特定域名
alert http any any -> any any (msg:"HTTP Request to Suspicious Domain"; http_host; content:"phishing.com"; sid:1000003; rev:1;)
EOF

# 启动Suricata
sudo systemctl start suricata
sudo systemctl enable suricata
```

#### 4.3.2 Zeek (Bro) 网络分析
```bash
# 安装Zeek
sudo apt install zeek

# 配置网络接口
sudo vim /usr/local/zeek/etc/node.cfg

# 基础监控脚本
cat > /usr/local/zeek/share/zeek/site/local.zeek << 'EOF'
# 加载HTTP模块
@load protocols/http

# 监控特定域名
event http_request(c: connection, method: string, original_URI: string, unescaped_URI: string, version: string)
{
    if ("suspicious-domain.com" in c$http$host)
    {
        print fmt("可疑域名访问: %s -> %s", c$id$orig_h, c$http$host);
    }
}

# 监控DNS查询
@load protocols/dns
event dns_request(c: connection, msg: dns_msg, query: string, qtype: count, qclass: count)
{
    if ("malicious" in query)
    {
        print fmt("可疑DNS查询: %s 查询 %s", c$id$orig_h, query);
    }
}
EOF

# 启动Zeek
sudo zeek -i eth0 /usr/local/zeek/share/zeek/site/local.zeek
```

## 5. 自动化监控脚本

### 5.1 全网扫描监控脚本
```bash
#!/bin/bash
# 全面的网络监控脚本

CONFIG_FILE="/etc/network_monitor.conf"
LOG_DIR="/var/log/network_monitor"
PID_FILE="/var/run/network_monitor.pid"

# 配置文件示例
cat > $CONFIG_FILE << 'EOF'
# 网络配置
NETWORK_RANGES=("192.168.1.0/24" "192.168.2.0/24" "10.0.0.0/24")
INTERFACES=("eth0" "eth1")

# 监控目标
SUSPICIOUS_DOMAINS=("malware.example.com" "phishing.example.net")
SUSPICIOUS_PORTS=(4444 5555 6666 1234 31337)
SUSPICIOUS_IPS=("1.2.3.4" "5.6.7.8")

# 扫描配置
SCAN_INTERVAL=300  # 5分钟扫描一次
CAPTURE_ROTATION=3600  # 1小时轮转一次
EOF

# 主监控函数
start_monitoring() {
    source $CONFIG_FILE
    mkdir -p $LOG_DIR
    
    echo $$ > $PID_FILE
    
    # 启动网络扫描
    while true; do
        for network in "${NETWORK_RANGES[@]}"; do
            echo "$(date): 扫描网段 $network" >> $LOG_DIR/scan.log
            nmap -sn $network | grep "Nmap scan report" >> $LOG_DIR/active_hosts.log
        done
        sleep $SCAN_INTERVAL
    done &
    
    # 启动抓包监控
    for interface in "${INTERFACES[@]}"; do
        # DNS监控
        tcpdump -i $interface port 53 -w $LOG_DIR/dns_$interface.pcap -G $CAPTURE_ROTATION &
        
        # 端口监控
        for port in "${SUSPICIOUS_PORTS[@]}"; do
            tcpdump -i $interface port $port -w $LOG_DIR/port_${port}_$interface.pcap -G $CAPTURE_ROTATION &
        done
    done
    
    # 实时分析
    tail -f $LOG_DIR/dns_*.pcap | tcpdump -r - -A | while read line; do
        for domain in "${SUSPICIOUS_DOMAINS[@]}"; do
            if echo "$line" | grep -qi "$domain"; then
                echo "$(date): 检测到可疑域名访问: $domain" >> $LOG_DIR/alerts.log
                # 发送告警
                echo "Alert: Suspicious domain access detected: $domain" | mail -s "Security Alert" admin@company.com
            fi
        done
    done &
}

# 停止监控
stop_monitoring() {
    if [ -f $PID_FILE ]; then
        PID=$(cat $PID_FILE)
        kill $PID
        pkill -f "tcpdump"
        pkill -f "network_monitor"
        rm -f $PID_FILE
        echo "监控已停止"
    fi
}

# 状态检查
check_status() {
    if [ -f $PID_FILE ]; then
        PID=$(cat $PID_FILE)
        if ps -p $PID > /dev/null; then
            echo "监控正在运行 (PID: $PID)"
        else
            echo "监控进程已停止"
            rm -f $PID_FILE
        fi
    else
        echo "监控未运行"
    fi
}

# 主程序
case "$1" in
    start)
        start_monitoring
        echo "网络监控已启动"
        ;;
    stop)
        stop_monitoring
        ;;
    status)
        check_status
        ;;
    restart)
        stop_monitoring
        sleep 2
        start_monitoring
        echo "网络监控已重启"
        ;;
    *)
        echo "使用方法: $0 {start|stop|status|restart}"
        exit 1
        ;;
esac
```

### 5.2 实时分析脚本
```bash
#!/bin/bash
# 实时网络流量分析脚本

INTERFACE="eth0"
ANALYSIS_LOG="/var/log/traffic_analysis.log"

# 实时分析函数
analyze_traffic() {
    tcpdump -i $INTERFACE -l -n | while read line; do
        # 提取源IP、目标IP、端口信息
        if echo "$line" | grep -E "^[0-9]{2}:[0-9]{2}:[0-9]{2}"; then
            TIMESTAMP=$(echo "$line" | awk '{print $1}')
            SRC_IP=$(echo "$line" | awk '{print $3}' | cut -d'.' -f1-4)
            DST_INFO=$(echo "$line" | awk '{print $5}')
            DST_IP=$(echo "$DST_INFO" | cut -d'.' -f1-4)
            DST_PORT=$(echo "$DST_INFO" | cut -d'.' -f5 | sed 's/://')
            
            # 检查可疑端口
            case $DST_PORT in
                4444|5555|6666|1234|31337)
                    echo "$(date): 可疑端口连接 $SRC_IP -> $DST_IP:$DST_PORT" >> $ANALYSIS_LOG
                    ;;
            esac
            
            # 检查内网到外网的异常连接
            if [[ $SRC_IP =~ ^192\.168\. ]] && [[ ! $DST_IP =~ ^192\.168\. ]]; then
                if [[ $DST_PORT -gt 1024 ]] && [[ $DST_PORT -lt 5000 ]]; then
                    echo "$(date): 可疑外网连接 $SRC_IP -> $DST_IP:$DST_PORT" >> $ANALYSIS_LOG
                fi
            fi
        fi
    done
}

# 启动分析
echo "开始实时流量分析..."
analyze_traffic
```

## 6. 数据分析和告警

### 6.1 日志分析脚本
```bash
#!/bin/bash
# 网络监控日志分析

LOG_DIR="/var/log/network_monitor"
REPORT_FILE="/tmp/network_analysis_report.txt"

echo "=== 网络监控分析报告 ===" > $REPORT_FILE
echo "生成时间: $(date)" >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 分析活跃主机
echo "=== 活跃主机统计 ===" >> $REPORT_FILE
if [ -f "$LOG_DIR/active_hosts.log" ]; then
    cat "$LOG_DIR/active_hosts.log" | grep "Nmap scan report" | \
    awk '{print $5}' | sort | uniq -c | sort -nr >> $REPORT_FILE
fi
echo "" >> $REPORT_FILE

# 分析可疑连接
echo "=== 可疑连接统计 ===" >> $REPORT_FILE
if [ -f "$LOG_DIR/alerts.log" ]; then
    grep "可疑" "$LOG_DIR/alerts.log" | tail -20 >> $REPORT_FILE
fi
echo "" >> $REPORT_FILE

# 分析端口访问
echo "=== 端口访问统计 ===" >> $REPORT_FILE
for port_file in $LOG_DIR/port_*.log; do
    if [ -f "$port_file" ]; then
        port=$(basename "$port_file" .log | cut -d'_' -f2)
        count=$(wc -l < "$port_file")
        echo "端口 $port: $count 次访问" >> $REPORT_FILE
    fi
done

# 发送报告
mail -s "网络监控日报" admin@company.com < $REPORT_FILE
```

### 6.2 自动告警系统
```bash
#!/bin/bash
# 自动告警系统

ALERT_THRESHOLD=10  # 告警阈值
CHECK_INTERVAL=60   # 检查间隔（秒）

send_alert() {
    local message="$1"
    local severity="$2"
    
    # 发送邮件告警
    echo "$message" | mail -s "[$severity] 网络安全告警" admin@company.com
    
    # 发送到Syslog
    logger -p local0.warning "$message"
    
    # 如果是高危告警，发送短信（需要配置短信网关）
    if [ "$severity" = "HIGH" ]; then
        # curl -X POST "https://sms-api.example.com/send" -d "message=$message&phone=13800138000"
        echo "高危告警已触发" >> /var/log/high_alerts.log
    fi
}

monitor_alerts() {
    while true; do
        # 检查DNS查询异常
        dns_count=$(grep -c "可疑域名" /var/log/network_monitor/alerts.log 2>/dev/null || echo 0)
        if [ $dns_count -gt $ALERT_THRESHOLD ]; then
            send_alert "检测到 $dns_count 次可疑域名查询，超过阈值 $ALERT_THRESHOLD" "HIGH"
        fi
        
        # 检查端口扫描
        scan_count=$(grep -c "端口扫描" /var/log/network_monitor/scan.log 2>/dev/null || echo 0)
        if [ $scan_count -gt $ALERT_THRESHOLD ]; then
            send_alert "检测到 $scan_count 次端口扫描活动，超过阈值 $ALERT_THRESHOLD" "MEDIUM"
        fi
        
        # 检查异常连接
        conn_count=$(grep -c "异常连接" /var/log/network_monitor/alerts.log 2>/dev/null || echo 0)
        if [ $conn_count -gt $ALERT_THRESHOLD ]; then
            send_alert "检测到 $conn_count 次异常网络连接，超过阈值 $ALERT_THRESHOLD" "HIGH"
        fi
        
        sleep $CHECK_INTERVAL
    done
}

# 启动监控
monitor_alerts
```

## 7. 部署和使用指南

### 7.1 环境准备
```bash
# 安装必要工具
sudo apt update
sudo apt install nmap tcpdump wireshark-common tshark masscan arp-scan netdiscover

# 创建目录结构
sudo mkdir -p /var/log/network_monitor
sudo mkdir -p /etc/network_monitor
sudo mkdir -p /usr/local/bin/network_monitor

# 设置权限
sudo chmod 755 /var/log/network_monitor
sudo chown root:root /etc/network_monitor
```

### 7.2 快速部署
```bash
#!/bin/bash
# 一键部署脚本

echo "开始部署网络监控系统..."

# 复制脚本到系统目录
cp network_monitor.sh /usr/local/bin/
cp traffic_analysis.sh /usr/local/bin/
cp alert_system.sh /usr/local/bin/

# 设置执行权限
chmod +x /usr/local/bin/network_monitor.sh
chmod +x /usr/local/bin/traffic_analysis.sh
chmod +x /usr/local/bin/alert_system.sh

# 创建系统服务
cat > /etc/systemd/system/network-monitor.service << 'EOF'
[Unit]
Description=Network Monitor Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/network_monitor.sh start
ExecStop=/usr/local/bin/network_monitor.sh stop
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOF

# 启用服务
systemctl daemon-reload
systemctl enable network-monitor.service
systemctl start network-monitor.service

echo "网络监控系统部署完成！"
echo "使用 'systemctl status network-monitor' 检查状态"
```

### 7.3 使用示例
```bash
# 启动监控
sudo /usr/local/bin/network_monitor.sh start

# 检查状态
sudo /usr/local/bin/network_monitor.sh status

# 查看实时日志
tail -f /var/log/network_monitor/alerts.log

# 手动扫描特定网段
nmap -sn 192.168.1.0/24

# 监控特定域名
tcpdump -i any port 53 -A | grep -i "suspicious-domain.com"
```

## 8. 故障排除

### 8.1 常见问题
1. **权限不足**：确保以root权限运行
2. **网卡接口错误**：使用`ip addr`查看正确的接口名
3. **防火墙阻断**：检查iptables规则
4. **磁盘空间不足**：定期清理抓包文件

### 8.2 性能优化
```bash
# 设置抓包文件轮转
logrotate_config="/etc/logrotate.d/network-monitor"
cat > $logrotate_config << 'EOF'
/var/log/network_monitor/*.pcap {
    daily
    rotate 7
    compress
    missingok
    notifempty
    create 644 root root
}
EOF

# 限制抓包文件大小
tcpdump -i any -w capture.pcap -C 100 -W 5  # 100MB，保留5个文件
```

---
**文档版本：** v1.0  
**创建日期：** $(date +%Y-%m-%d)  
**适用范围：** 局域网安全监控  
**维护人员：** 网络安全团队 